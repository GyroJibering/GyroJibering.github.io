---
layout: post
title: ç”¨å…«åå²è€å¥¶ä¹Ÿèƒ½å¬æ‡‚çš„è¯æ€»ç»“äº†é¢è¯•å¸¸ç”¨çš„Webå®‰å…¨æ¼æ´
date: 2025-12-23
categories: [å®‰å…¨, é¢è¯•]
tags: [Webå®‰å…¨, é¢è¯•, SQLæ³¨å…¥, XSS, CSRF, SSRF, LLMæ”»é˜²]
toc: true
author: GyroJ
---

> é¢å‘ **åç«¯ / å®‰å…¨ / å¼€å‘å²—é¢è¯•**
> SQL æ³¨å…¥ã€PDOã€CORSã€XSSã€CSRFã€SSRFã€XXEã€æœ¬åœ°/æ¨ªå‘ææƒã€‚
> è®¡åˆ’é•¿æœŸæ›´æ–°,è¿™ç®—æ˜¯ä¸€æœ¬ã€Šæ°¸ä¹å¤§å…¸ã€‹å—ï¼Ÿå°½é‡äººå†™ï¼ŒAIç‡æ§åˆ¶åœ¨æœ€ä½

---

## SQLæ³¨å…¥

### çŸ¥è¯†ç‚¹æ”¶é›†æ•´ç†
å¸ƒå°”ç›²æ³¨ã€æ—¶é—´ç›²æ³¨ã€äºŒæ¬¡æ³¨å…¥ã€é”™è¯¯æ³¨å…¥ã€å¦‚ä½•ä½¿ç”¨sqlmapã€å¦‚ä½•è¿›è¡Œfuzz

#### SQLè¯­å¥çš„å‡ ç§ç±»å‹ï¼ˆä»æ”»å‡»è€…è§’åº¦æ€è€ƒ

DQL/DMLï¼Œé€šå¸¸æ˜¯å•ä¸ªå‚æ•°æŸ¥è¯¢æˆ–è€…è®¾ç½®ï¼Œæ¯”å¦‚SELECTï¼ŒINSERTï¼ŒUPDATEï¼Œæœ€ç®€å•çš„æ³¨å…¥ï¼Œå¯ä»¥é€šè¿‡ORMæˆ–è€…é¢„è¾“å…¥å¤„ç†æ¥è¿›è¡Œé˜²æŠ¤ï¼Œä½†æ˜¯é˜²ä¸ä½ORDER BY

DDL/DCL, åªèƒ½é€šè¿‡æœ€å°æƒé™åŸåˆ™ã€é»‘ç™½åå•æ¥å¤„ç†



>***ORMï¼ˆObject Relational Mappingï¼‰é€šè¿‡å¯¹è±¡æ¨¡å‹æ˜ å°„å…³ç³»æ•°æ®åº“ï¼Œè‡ªåŠ¨ç”Ÿæˆ SQL å¹¶è´Ÿè´£å‚æ•°ç»‘å®šã€‚ä½ ä¸å†æ‰‹å†™ SQLï¼Œè€Œæ˜¯ç”¨ä»£ç æ“ä½œ"å¯¹è±¡"ï¼ŒORM å¸®ä½ å®‰å…¨åœ°æ‹¼ SQL***ã€‚

---
### SQLæ³¨å…¥ç»•è¿‡æŠ€å·§

#### åŸºç¡€ç»•è¿‡
**ç©ºæ ¼ç»•è¿‡**ï¼š`/**/`ã€`%09`(Tab)ã€`%0a`(æ¢è¡Œ)ã€`%0d`(å›è½¦)ã€`()`ã€`+`

**å¼•å·ç»•è¿‡**ï¼š`0x616461696e`(åå…­è¿›åˆ¶)ã€`CHAR(97,100,109,105,110)`ã€`CONCAT()`ã€`%df'`(å®½å­—èŠ‚)

**å…³é”®å­—ç»•è¿‡**ï¼š`SeLeCt`(å¤§å°å†™)ã€`selselectect`(åŒå†™)ã€`SEL/**/ECT`(å†…è”æ³¨é‡Š)ã€`/*!50000SELECT*/`(ç‰ˆæœ¬æ³¨é‡Š)ã€`%53%45%4c%45%43%54`(URLç¼–ç )

**ç¼–ç ç»•è¿‡**ï¼š`%27`(URLç¼–ç )ã€`%2527`(åŒé‡ç¼–ç )ã€`%u0027`(Unicode)ã€`&#39;`(HTMLå®ä½“)ã€Base64

**å®½å­—èŠ‚æ³¨å…¥**ï¼š`%df'`(GBK)ã€`%a1'`(Big5)ã€`%81'`(Shift-JIS)

#### è¯­æ³•æ›¿æ¢
**é€»è¾‘è¿ç®—ç¬¦**ï¼š`&&`(æ›¿ä»£AND)ã€`||`(æ›¿ä»£OR)ã€`LIKE/IN()/BETWEEN/REGEXP`(æ›¿ä»£=)

**å‡½æ•°æ›¿æ¢**ï¼š`SUBSTR/MID/LEFT/RIGHT`(å­—ç¬¦ä¸²æˆªå–)ã€`IF/CASE WHEN`(æ¡ä»¶åˆ¤æ–­)ã€`BENCHMARK/GET_LOCK`(æ›¿ä»£SLEEP)

**ç­‰ä»·å‡½æ•°**ï¼š`@@version`(æ›¿ä»£version())ã€`schema()`(æ›¿ä»£database())ã€`current_user()`(æ›¿ä»£user())ã€`||/+`(å­—ç¬¦ä¸²è¿æ¥)

#### ç‰¹æ®Šåœºæ™¯
**å‚æ•°æ±¡æŸ“**ï¼š`id=1&id=2` - æµ‹è¯•å–ç¬¬ä¸€ä¸ª/æœ€åä¸€ä¸ª/æ‹¼æ¥

**å †å æŸ¥è¯¢**ï¼š`;DROP TABLE`ã€`;UPDATE`ã€`;EXEC xp_cmdshell`

**äºŒæ¬¡æ³¨å…¥**ï¼šæ’å…¥æ—¶è¢«è½¬ä¹‰ â†’ æŸ¥è¯¢æ—¶è§¦å‘ï¼ˆæœªè½¬ä¹‰ï¼‰

#### æ—¶é—´ç›²æ³¨å‡½æ•°ï¼ˆæŒ‰æ•°æ®åº“ï¼‰
- **MySQL**ï¼š`SLEEP(5)`ã€`BENCHMARK()`
- **SQL Server**ï¼š`WAITFOR DELAY '0:0:5'`
- **PostgreSQL**ï¼š`pg_sleep(5)`
- **Oracle**ï¼š`DBMS_LOCK.SLEEP(5)`

#### æŠ¥é”™æ³¨å…¥å‡½æ•°ï¼ˆæŒ‰æ•°æ®åº“ï¼‰
- **MySQL**ï¼š`updatexml()`ã€`extractvalue()`ã€`floor(rand()*2)`ã€`exp()`ã€`GeometryCollection()`
- **SQL Server**ï¼š`CONVERT(int, @@version)`
- **Oracle**ï¼š`utl_inaddr.get_host_address()`ã€`XMLType()`
- **PostgreSQL**ï¼š`CAST(version() AS int)`

#### å¸¸ç”¨Payload
```sql
-- åˆ¤æ–­åˆ—æ•°
' ORDER BY 1-- / ' ORDER BY 2--

-- è”åˆæ³¨å…¥
' UNION SELECT 1,2,3--
' UNION SELECT null,database(),user()--

-- å¸ƒå°”ç›²æ³¨
' AND 1=1--
' AND SUBSTRING(database(),1,1)='a'--

-- æ—¶é—´ç›²æ³¨
' AND IF(1=1,SLEEP(5),0)--

-- æŠ¥é”™æ³¨å…¥
' AND updatexml(1,concat(0x7e,database()),1)--
```

### é¢è¯•é—®é¢˜
1.ç»™ä½ ä¸€ä¸ªjavaåº”ç”¨ç™½ç›’æµ‹è¯•ï¼Œå¦‚ä½•å¿«é€ŸæŸ¥æ‰¾å¯èƒ½çš„SQLæ³¨å…¥ç‚¹
#### æŸ¥æ‰¾æ–¹æ³•

æŸ¥æ‰¾é«˜å±API
```java
Statement
createStatement
execute
executeQuery
executeUpdate
addBatch
```
```java
// å±é™©æ¨¡å¼ - å­—ç¬¦ä¸²æ‹¼æ¥
String sql = "SELECT * FROM users WHERE id=" + userId;
Statement stmt = conn.createStatement();
stmt.executeQuery(sql);

// å±é™©æ¨¡å¼ - MyBatis ${}
<select id="getUser">
  SELECT * FROM users WHERE name = '${userName}'
</select>
```
ç»Ÿè®¡ç”¨æˆ·è¾“å…¥æºï¼Œå¯ä»¥é¡ºä¾¿æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦å­˜åœ¨javaååºåˆ—åŒ–æ¼æ´
```java
request.getParameter()
@RequestParam
@RequestBody
@PathVariable
@ModelAttribute
```
#### å®¡è®¡è¦ç‚¹
- æœç´¢å…³é”®å­—ï¼š`Statement`ã€`executeQuery`ã€`executeUpdate`ã€`${}(MyBatis)`
- æ£€æŸ¥ç”¨æˆ·è¾“å…¥æ˜¯å¦ç›´æ¥æ‹¼æ¥åˆ°SQL
- ç¡®è®¤æ˜¯å¦ä½¿ç”¨`PreparedStatement`å’Œ`#{}`(MyBatis)
- æ˜¯å¦å­˜åœ¨å­—ç¬¦ä¸²æ‹¼æ¥ã€æ˜¯å¦æœ‰ä¸å¯å‚æ•°åŒ–çš„ SQL ç»“æ„ï¼Œä»¥åŠ ORM è¢«è¯¯ç”¨çš„åœºæ™¯ï¼Œ
å°¤å…¶æ˜¯ ORDER BYã€åŠ¨æ€æ¡ä»¶å’ŒåŸç”Ÿ SQLï¼Œè¿™äº›åœ°æ–¹åœ¨çœŸå®é¡¹ç›®ä¸­æœ€å®¹æ˜“å‡ºé—®é¢˜


## æµè§ˆå™¨èƒŒæ™¯çŸ¥è¯†è¡¥å……æ¦‚è§ˆ

è¿™éƒ¨åˆ†æˆ‘åªæ”¾ä¸€ä¸ªæ€»ç»“çš„æ ‘çŠ¶å›¾ï¼Œç±»ä¼¼æ€ç»´å¯¼å›¾çš„æ•ˆæœï¼Œå…·ä½“æ¯ä¸€éƒ¨åˆ†çš„ç»†èŠ‚æ–¹é¢ï¼Œéœ€è¦å»å…¶ä»–åœ°æ–¹è¡¥å……ï¼Œæ•´ä¸ªçŸ¥è¯†ä½“ç³»å…¨éƒ¨ä¸²è”èµ·æ¥çš„æ„Ÿè§‰æ˜¯éå¸¸äº«å—çš„ï¼Œé›¶é›¶æ•£æ•£å­¦çš„ä¸œè¥¿è¿‡å‡ å¤©å°±å¿˜äº†ï¼ŒæŠŠæµè§ˆå™¨å†…æ ¸å…¨éƒ¨çœ‹å®Œï¼Œæœ‰ç§èŒ…å¡é¡¿å¼€çš„æ„Ÿè§‰ã€‚

>***çŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶***

```
æ“ä½œç³»ç»Ÿï¼ˆKernel / Hardwareï¼‰
â””â”€â”€ æµè§ˆå™¨ä¸»è¿›ç¨‹ï¼ˆBrowser Processï¼‰ã€é«˜æƒé™ã€‘
    â”œâ”€â”€ ç½‘ç»œè¿›ç¨‹ï¼ˆNetwork Processï¼‰ã€å—æ§é«˜æƒé™ã€‘
    â”œâ”€â”€ GPU è¿›ç¨‹ï¼ˆGPU Processï¼‰ã€å—æ§æƒé™ã€‘
    â”œâ”€â”€ æ¸²æŸ“è¿›ç¨‹ï¼ˆRenderer Processï¼‰ã€ä½æƒé™ / Sandboxã€‘
    â”‚   â”œâ”€â”€ V8ï¼ˆJavaScript Engineï¼‰
    â”‚   â”œâ”€â”€ Blinkï¼ˆDOM / HTML / CSSï¼‰
    â”‚   â”œâ”€â”€ DOM Tree
    â”‚   â”œâ”€â”€ CSSOM
    â”‚   â””â”€â”€ Layout / Paint
    â””â”€â”€ å·¥å…· / æ’ä»¶è¿›ç¨‹ï¼ˆUtility / Pluginï¼‰
```

```
Renderer Processï¼ˆSandboxedï¼‰
â”œâ”€â”€ JavaScript æ‰§è¡Œå±‚
â”‚   â”œâ”€â”€ V8 Runtime
â”‚   â”‚   â”œâ”€â”€ Interpreterï¼ˆIgnitionï¼‰
â”‚   â”‚   â”œâ”€â”€ JIT Compilerï¼ˆTurboFanï¼‰
â”‚   â”‚   â””â”€â”€ Garbage Collector
â”‚   â””â”€â”€ Web APIsï¼ˆå—é™æ¥å£ï¼‰
â”‚       â”œâ”€â”€ fetch / XHR
â”‚       â”œâ”€â”€ setTimeout / Promise
â”‚       â””â”€â”€ DOM API
â”‚
â”œâ”€â”€ æ–‡æ¡£ç»“æ„å±‚
â”‚   â”œâ”€â”€ HTML Parser
â”‚   â”œâ”€â”€ DOM Tree
â”‚   â””â”€â”€ Shadow DOM
â”‚
â”œâ”€â”€ æ ·å¼ä¸å¸ƒå±€å±‚
â”‚   â”œâ”€â”€ CSS Parser
â”‚   â”œâ”€â”€ CSSOM
â”‚   â”œâ”€â”€ Layout Tree
â”‚   â””â”€â”€ Paint Records
â”‚
â””â”€â”€ IPC é€šé“ï¼ˆåªèƒ½â€œè¯·æ±‚â€ï¼Œä¸èƒ½â€œæ‰§è¡Œâ€ï¼‰
    â”œâ”€â”€ â†’ Network Process
    â”œâ”€â”€ â†’ Browser Process
    â””â”€â”€ â†’ GPU Process
```
```
JavaScript (fetch / form / img)
â””â”€â”€ Renderer Process
    â””â”€â”€ IPC è¯·æ±‚
        â””â”€â”€ Network Process
            â”œâ”€â”€ Cookie åŒ¹é… + é™„åŠ 
            â”œâ”€â”€ SameSite åˆ¤æ–­
            â”œâ”€â”€ CORS / Preflight
            â””â”€â”€ å‘å‡ºçœŸå® HTTP è¯·æ±‚
                â””â”€â”€ Internet
```
ä¸€æ¬¡å®Œæ•´çš„HTTPSè¯·æ±‚è¿‡ç¨‹
```
JS fetch("https://bank.com/api")
â”‚
â””â”€â”€ Renderer Process
    â””â”€â”€ IPCï¼šæˆ‘è¦è¯·æ±‚è¿™ä¸ª URL
        â”‚
        â””â”€â”€ Network Process
            â”œâ”€â”€ DNS
            â”œâ”€â”€ TCP connect
            â”œâ”€â”€ TLS Handshake
            â”‚   â”œâ”€â”€ ClientHello
            â”‚   â”œâ”€â”€ ServerHello
            â”‚   â”œâ”€â”€ Certificate
            â”‚   â””â”€â”€ Key Exchange
            â”œâ”€â”€ HTTP è¯·æ±‚ï¼ˆæ˜æ–‡ï¼‰
            â”œâ”€â”€ TLS åŠ å¯†
            â””â”€â”€ TCP å‘åŒ…
                â””â”€â”€ Internet
```
>*** æµè§ˆå™¨æŒ‡çº¹æ˜¯JSé‡‡é›†çš„ï¼Œä¾‹å¦‚æ— å¤´çˆ¬è™«çš„ä¸»è¦æ£€æµ‹æ–¹æ³•å°±æ˜¯```navigator.webdriver === true```ï¼Œå½“ç„¶è¿˜åŒ…æ‹¬å…¶ä»–å¾ˆå¤šä¿¡æ¯ï¼ŒæŒ‡çº¹è¯†åˆ«æ˜¯å‰ç«¯JSä»£ç è‡ªåŠ¨è¯†åˆ«çš„ç»“æœï¼Œå¯ä»¥ä¼ªè£… ***

Renderer RCE + Kernel LPEå¯ä»¥é€ æˆæ²™ç®±é€ƒé€¸ï¼Œä»è€Œåˆ©ç”¨æµè§ˆå™¨æ‹¿ä¸‹ä¸»æœºè®¾å¤‡æ§åˆ¶æƒã€‚

å…·ä½“æ¡ˆä¾‹ï¼šCVE-2021-1732ï¼Œwin32k åœ¨å¤„ç†çª—å£å¯¹è±¡æ—¶å­˜åœ¨ Use-After-Freeï¼Œç”¨æˆ·æ€å¯æ§æŒ‡é’ˆè¢«å†…æ ¸é”™è¯¯ä½¿ç”¨ã€‚è¿™ä¸€å—å°±æ¶‰åŠå¾ˆå¤špwnç›¸å…³çš„å†…å®¹äº†ï¼Œæ¯”å¦‚UAFçš„åˆ©ç”¨è¿‡ç¨‹ã€‚çœ‹æ¥ï¼Œpwnæ‰æ˜¯åšå®‰å…¨çš„å¿…ç»ä¹‹è·¯å•Šã€‚

>***çœ‹æ‡‚äº†æµè§ˆå™¨å†…æ ¸ï¼Œæ‰€æœ‰çš„xssã€csrfè¿™ä¸€ç±»åˆ©ç”¨æµè§ˆå™¨çš„æ¼æ´å°±éå¸¸å®¹æ˜“ç†è§£äº†***

## XSS

ç°åœ¨ä½ åº”è¯¥å¯¹æµè§ˆå™¨æ¶æ„æœ‰ä¸€ä¸ªéå¸¸å®Œå–„çš„è®¤çŸ¥äº†ï¼Œæˆ‘å¸Œæœ›ä½ åœ¨é¢è¯•çš„æ—¶å€™å¯ä»¥æå‡ºæ¥ä»€ä¹ˆæ˜¯SPAã€ä»€ä¹ˆæ˜¯CSPï¼Œç†è§£è¿™äº›ï¼Œä½ ä¹Ÿå°±æ‡‚xssçš„æˆå› äº†ï¼Œç‰¹åˆ«æ˜¯dom-xssï¼Œå®é™…ä¸Šå°±æ˜¯ç”±äºSPAçš„å‡ºç°ï¼ŒSPA å°†å¤§é‡ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†å‰ç§»åˆ°æµè§ˆå™¨ç«¯ï¼Œç”¨æˆ·å¯æ§çš„æ•°æ®å¾€å¾€ç›´æ¥å‚ä¸å‰ç«¯è·¯ç”±å’Œ DOM æ›´æ–°ï¼Œè¿™æ˜¾è‘—æ”¾å¤§äº† DOM-XSS çš„æ”»å‡»é¢ã€‚
DOM-XSS çš„æœ¬è´¨å¹¶ä¸åœ¨äºæ˜¯å¦ä¸æœåŠ¡å™¨äº¤äº’ï¼Œè€Œæ˜¯ä¸å¯ä¿¡æ•°æ®åœ¨æµè§ˆå™¨å†…éƒ¨è¿›å…¥äº†å¯æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚
URL fragmentï¼ˆé”šç‚¹ï¼‰æœ¬èº«åªæ˜¯æµè§ˆå™¨ä¾§çš„æ•°æ®æ¥æºï¼ŒCSP å¹¶ä¸ä¼šå¯¹å…¶è¿›è¡Œé™åˆ¶ï¼›ä½†å½“è¿™äº›æ•°æ®è¢«å‰ç«¯ä»£ç æ³¨å…¥åˆ° DOM å¹¶è§¦å‘è„šæœ¬æ‰§è¡Œæ—¶ï¼ŒCSP ä¼šåœ¨æ‰§è¡Œé˜¶æ®µç”Ÿæ•ˆã€‚
å®é™…ä¸Šï¼Œè®¸å¤šæ‰€è°“â€œhash-based XSS ç»•è¿‡ CSPâ€çš„æƒ…å†µï¼Œå¹¶é CSP æœºåˆ¶å¤±æ•ˆï¼Œè€Œæ˜¯ç”±äº CSP é…ç½®è¿‡äºå®½æ¾ï¼Œå…è®¸å†…è”äº‹ä»¶æˆ–å±é™© DOM API çš„æ‰§è¡Œ

>***CSPï¼ˆContent Security Policyï¼‰ç”±ç½‘ç«™é€šè¿‡ HTTP å“åº”å¤´æˆ– HTML meta æ ‡ç­¾å£°æ˜ï¼Œæœ€ç»ˆç”±æµè§ˆå™¨å¼ºåˆ¶æ‰§è¡Œã€‚CSPé…ç½®æ­£ç¡®çš„æƒ…å†µä¸‹å¯ä»¥ç”¨æ¥é˜²æŠ¤Dom-XSS***

### XSSæŠ€èƒ½æ ‘
æ”»å‡»
```
XSS åˆ©ç”¨
â”œâ”€â”€ åŸºç¡€æ‰§è¡Œ
â”‚   â”œâ”€â”€ alert / console
â”‚   â””â”€â”€ Cookie / Storage
â”‚
â”œâ”€â”€ window åˆ©ç”¨
â”‚   â”œâ”€â”€ window.openerï¼ˆtabnabbingï¼‰
â”‚   â”œâ”€â”€ window.nameï¼ˆè·¨åŸŸå­˜å‚¨ï¼‰
â”‚   â”œâ”€â”€ window.parent / top
â”‚   â””â”€â”€ postMessage æ³¨å…¥
â”‚
â”œâ”€â”€ iframe åˆ©ç”¨
â”‚   â”œâ”€â”€ åŒæº iframe ææƒ
â”‚   â”œâ”€â”€ é’“é±¼ / UI è¦†ç›–
â”‚   â”œâ”€â”€ C2 / æŒä¹…æ§åˆ¶
â”‚   â””â”€â”€ sandbox è¯¯é…ç½®
â”‚
â”œâ”€â”€ æƒé™æ‰©å±•
â”‚   â”œâ”€â”€ CSRF
â”‚   â”œâ”€â”€ SSRF
â”‚   â”œâ”€â”€ è´¦å·æ¥ç®¡
â”‚   â””â”€â”€ åå°åŠ«æŒ
â”‚
â””â”€â”€ æŒä¹…åŒ–
    â”œâ”€â”€ localStorage
    â”œâ”€â”€ Service Workerï¼ˆé«˜çº§ï¼‰
    â””â”€â”€ WebSocket

```
```
ç»•è¿‡æ‰‹æ®µ
â”œâ”€â”€ ç¼–ç ç»•è¿‡
â”‚   â”œâ”€â”€ HTML å®ä½“
â”‚   â”‚   `<img src=x onerror=&lt;script&gt;alert(1)&lt;/script&gt;>`
â”‚   â”‚
â”‚   â”œâ”€â”€ URL ç¼–ç 
â”‚   â”‚   `<img src=x onerror=%61%6c%65%72%74(1)>`
â”‚   â”‚
â”‚   â””â”€â”€ Unicode
â”‚       `<img src=x onerror=\u0061\u006c\u0065\u0072\u0074(1)>`
â”‚
â”œâ”€â”€ äº‹ä»¶è§¦å‘
â”‚   â”œâ”€â”€ onerror
â”‚   â”‚   `<img src=x onerror=alert(1)>`
â”‚   â”‚
â”‚   â”œâ”€â”€ onload
â”‚   â”‚   `<body onload=alert(1)>`
â”‚   â”‚
â”‚   â””â”€â”€ SVG
â”‚       `<svg><script>alert(1)</script></svg>`
â”‚
â”œâ”€â”€ æ ‡ç­¾åˆ©ç”¨
â”‚   â”œâ”€â”€ img
â”‚   â”‚   `<img src=x onerror=alert(1)>`
â”‚   â”‚
â”‚   â”œâ”€â”€ svg
â”‚   â”‚   `<svg onload=alert(1)>`
â”‚   â”‚
â”‚   â”œâ”€â”€ iframe
â”‚   â”‚   `<iframe srcdoc="<script>alert(1)</script>"></iframe>`
â”‚   â”‚
â”‚   â””â”€â”€ math
â”‚       `<math><mtext onclick="alert(1)">X</mtext></math>`
â”‚
â”œâ”€â”€ åè®®åˆ©ç”¨
â”‚   â”œâ”€â”€ javascript:
â”‚   â”‚   `<a href="javascript:alert(1)">click</a>`
â”‚   â”‚
â”‚   â”œâ”€â”€ data:
â”‚   â”‚   `<img src="data:image/svg+xml,<svg onload=alert(1)>">`
â”‚   â”‚
â”‚   â””â”€â”€ blob:
â”‚       `URL.createObjectURL(new Blob(["<script>alert(1)</script>"],{type:"text/html"}))`
â”‚
â””â”€â”€ æ¡†æ¶ç‰¹æ€§
    â”œâ”€â”€ Vue v-html
    â”‚   `<div v-html="'<img src=x onerror=alert(1)>'"></div>`
    â”‚
    â”œâ”€â”€ React dangerouslySetInnerHTML
    â”‚   `{ dangerouslySetInnerHTML:{__html:'<svg onload=alert(1)>'} }`
    â”‚
    â””â”€â”€ innerHTML åŒ…è£…
        `element.innerHTML = "<iframe srcdoc='<script>alert(1)</script>'>"`
```

```
æµè§ˆå™¨å®‰å…¨æœºåˆ¶
â”œâ”€â”€ SOPï¼ˆåŒæºç­–ç•¥ï¼‰
â”‚   â””â”€â”€ âŒ ä¸é˜² XSS
â”‚
â”œâ”€â”€ CSP
â”‚   â”œâ”€â”€ script-src
â”‚   â”œâ”€â”€ unsafe-inline
â”‚   â””â”€â”€ nonce / hash
â”‚
â”œâ”€â”€ HttpOnly Cookie
â”‚   â””â”€â”€ é˜² Cookie çªƒå–
â”‚
â””â”€â”€ sandbox iframe
```
```
é˜²å¾¡
â”œâ”€â”€ è¾“å…¥éªŒè¯ï¼ˆä¸å¯é ï¼‰
â”œâ”€â”€ è¾“å‡ºç¼–ç ï¼ˆæœ€å…³é”®ï¼‰
â”‚   â”œâ”€â”€ HTML Encode
â”‚   â”œâ”€â”€ JS Encode
â”‚   â””â”€â”€ URL Encode
â”‚
â”œâ”€â”€ ç¦ç”¨å±é™© API
â”‚   â”œâ”€â”€ eval
â”‚   â”œâ”€â”€ innerHTML
â”‚
â”œâ”€â”€ CSP
â”‚   â”œâ”€â”€ ç¦æ­¢ inline
â”‚   â”œâ”€â”€ ç¦æ­¢ eval
â”‚
â””â”€â”€ æ¡†æ¶è‡ªåŠ¨è½¬ä¹‰

```
### å±å®³

* çªƒå– Cookieï¼ˆé HttpOnlyï¼‰
* åŠ«æŒç™»å½•æ€
* é’“é±¼ã€é”®ç›˜è®°å½•
* é…åˆ CSRF / SSRF

ç®€å• XSS é˜²æŠ¤ç¤ºä¾‹

```php
function xss_filter($input) {
    return htmlspecialchars($input, ENT_QUOTES, 'UTF-8');
}
```

> ä¸è¿‡æ»¤è¾“å…¥ï¼Œè€Œæ˜¯**åœ¨è¾“å‡ºæ—¶åšç¼–ç **


HttpOnly ä¸ºä»€ä¹ˆ JS è¯»ä¸åˆ° Cookie

```http
Set-Cookie: PHPSESSID=xxx; HttpOnly
```

* æµè§ˆå™¨ç¦æ­¢ `document.cookie` è®¿é—®
* ä½† Cookie ä»ä¼šéšè¯·æ±‚å‘é€

>ğŸ‘‰ é˜² XSS çªƒ Cookieï¼Œä¸é˜² CSRF

---
### XSSæ¼æ´å®¡è®¡

#### ç™½ç›’å®¡è®¡
```java
// å±é™©ä»£ç æ¨¡å¼
out.println("<div>" + userInput + "</div>");  // æœªç¼–ç 
response.getWriter().write(request.getParameter("name")); // ç›´æ¥è¾“å‡º

// JSPä¸­
<div>${param.name}</div>  <!-- JSTLé»˜è®¤è½¬ä¹‰ï¼Œä½†æŸäº›æƒ…å†µä¾‹å¤– -->
<div><%=request.getParameter("name")%></div>  <!-- å±é™© -->
```

**å®¡è®¡è¦ç‚¹:**
- å’Œä¸Šé¢çš„SQLæ³¨å…¥å®¡è®¡ä¸€æ ·çš„æ–¹æ³•è®ºæœç´¢ï¼š`getParameter`ã€`getAttribute`ã€è¾“å‡ºå‡½æ•°
- æ£€æŸ¥æ˜¯å¦ç»è¿‡HTMLç¼–ç ï¼š`StringEscapeUtils.escapeHtml4()`
- æ£€æŸ¥å¯Œæ–‡æœ¬ï¼šæ˜¯å¦ä½¿ç”¨ç™½åå•è¿‡æ»¤ï¼ˆjsoupã€OWASP AntiSamyï¼‰

### é»‘ç›’å®¡è®¡
```bash
# æµ‹è¯•åå°„å‹XSS
http://target.com/search?q=<script>alert(1)</script>
http://target.com/page?name=<img src=x onerror=alert(1)>

# æµ‹è¯•å­˜å‚¨å‹XSS
æ³¨å†Œç”¨æˆ·å: <svg/onload=alert(1)>
å‘è¡¨è¯„è®º: "><script>alert(document.cookie)</script>

# æµ‹è¯•DOM-XSS
http://target.com/page#<img src=x onerror=alert(1)>
```
æ³¨æ„è¿™é‡Œçš„#æ˜¯é‡ç‚¹ï¼Œè¿™ä¸ª#ï¼Œé€šä¿—çš„å¯ä»¥å«åšé”šç‚¹
#çš„ä½œç”¨ï¼š
ä¸ä¼šå‘é€åˆ°æœåŠ¡å™¨ï¼šç‰‡æ®µæ ‡è¯†ç¬¦ï¼ˆå³#ä¹‹åçš„å†…å®¹ï¼‰ä¸ä¼šè¢«åŒ…å«åœ¨HTTPè¯·æ±‚ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æµè§ˆå™¨å‘æœåŠ¡å™¨è¯·æ±‚```http://target.com/page```æ—¶ï¼Œ#åé¢çš„éƒ¨åˆ†ä¸ä¼šå‘é€åˆ°æœåŠ¡å™¨ï¼Œè€Œæ˜¯ç”±å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ä¿ç•™å¹¶ä½¿ç”¨ã€‚
å®¢æˆ·ç«¯å¤„ç†ï¼šç”±äºç‰‡æ®µæ ‡è¯†ç¬¦ä¸ä¼šå‘é€åˆ°æœåŠ¡å™¨ï¼Œå› æ­¤æœåŠ¡å™¨æ— æ³•ç›´æ¥æ§åˆ¶æˆ–è®¿é—®å®ƒã€‚å®ƒå®Œå…¨ç”±å®¢æˆ·ç«¯å¤„ç†ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœç½‘é¡µä¸­çš„JavaScriptä»£ç è¯»å–äº†window.location.hashå¹¶è¿›è¡Œäº†ä¸å®‰å…¨çš„å†…åµŒæˆ–æ‰§è¡Œï¼Œå°±å¯èƒ½å¯¼è‡´å®‰å…¨é—®é¢˜ï¼ˆä¾‹å¦‚XSSï¼‰ã€‚
>***æ£€æµ‹å·¥å…·: XSStrikeã€Burp Suiteã€AWVS***

---

## CSRF
äººè¯è§£é‡Šï¼šCSRFå°±æ˜¯æˆ‘æ„é€ ä¸€ä¸ªé’“é±¼ç½‘ç«™ï¼Œç„¶åé€šè¿‡postæäº¤è¡¨å•åˆ°å…¶ä»–ç½‘ç«™çš„apiæ¥å£ï¼Œæ­¤æ—¶æµè§ˆå™¨è‡ªåŠ¨å¸¦ä¸Šäº†cookieï¼Œå¯¼è‡´CSRFã€‚
>***ä¸€äº›ç»†èŠ‚ï¼šCSRF æœ¬è´¨ä¸Šåªæ˜¯åˆ©ç”¨æµè§ˆå™¨å‘å‡ºè¯·æ±‚ï¼Œæ”»å‡»è€…ä¸€èˆ¬æ— æ³•è¯»å–å“åº”å†…å®¹ï¼Œè¿™æ˜¯ç”±äºæµè§ˆå™¨åŒæºç­–ç•¥çš„é™åˆ¶ã€‚***

è¯¦ç»†ä¸€ç‚¹è§£é‡Šï¼š
CSRF çš„äº§ç”Ÿæºäºæµè§ˆå™¨å¯¹ Cookie çš„è‡ªåŠ¨æºå¸¦æœºåˆ¶ï¼ŒåŒæºç­–ç•¥ä»…é™åˆ¶å“åº”è¯»å–è€Œä¸é™åˆ¶è¯·æ±‚å‘é€ï¼›SameSite Cookie æ˜¯ç°ä»£é˜²å¾¡æ ¸å¿ƒï¼Œè€Œä¸€æ—¦å­˜åœ¨ XSSï¼ŒCSRF é˜²æŠ¤å°†è¢«å®Œå…¨ç»•è¿‡ï¼›JSONP åˆ™æ˜¯å†å²ä¸Šç»•è¿‡åŒæºç­–ç•¥ã€æ”¾å¤§ CSRF ä¸ä¿¡æ¯æ³„éœ²é£é™©çš„å…¸å‹è®¾è®¡ç¼ºé™·ã€‚

### é¢è¯•é‡åˆ°çš„é—®é¢˜ï¼šä¸ºä»€ä¹ˆåç«¯apiä½¿ç”¨jsonä¸èƒ½å®Œå…¨é˜²ä½csrf
åŸç†ä¸Šå‡ºå‘ï¼šä¼ ç»Ÿcsrfæ˜¯ä½¿ç”¨æµè§ˆå™¨ç›´æ¥å‘é€è¡¨å•ï¼Œä¸èƒ½å‘é€jsonæ•°æ®ï¼Œå¦‚æœè¦å‘é€jsonæ•°æ®ï¼Œå°±å¿…é¡»è¦è°ƒå–JSï¼Œä½†æ˜¯è°ƒå–JSçš„è¿‡ç¨‹ä¸­å—åˆ°CORSçš„é˜»ç¢

CSRF å¹¶ä¸æ˜¯ä¸èƒ½å‘é€ JSONï¼Œè€Œæ˜¯åœ¨æ²¡æœ‰ XSS çš„å‰æä¸‹ï¼Œæµè§ˆå™¨ä¸å…è®¸è·¨ç«™é¡µé¢æ„é€ å¹¶å‘é€æºå¸¦ application/json çš„è¯·æ±‚ï¼›å› ä¸ºä¼šè§¦å‘CORSé¢„æ£€(OPTIONS)å› æ­¤â€œJSON API çœ‹èµ·æ¥ä¸å®¹æ˜“è¢« CSRFâ€æ˜¯æµè§ˆå™¨å®‰å…¨æ¨¡å‹çš„å‰¯ä½œç”¨ï¼Œè€Œä¸æ˜¯ JSON è‡ªèº«çš„å®‰å…¨æ€§ã€‚
>***CORSé¢„æ£€ï¼šåœ¨å‘é€è·¨ç«™è¯·æ±‚çš„æ—¶å€™ä¼šè¢«è§¦å‘ï¼Œæµè§ˆå™¨è‡ªåŠ¨å‘æœåŠ¡å™¨å‘é€OPTIONSè¯·æ±‚ï¼Œè¯¢é—®æµè§ˆå™¨ï¼šâ€œæ¥ä¸‹æ¥æˆ‘è¦ç»™ä½ å‘ä¸€ä¸ªè¿™æ ·çš„è·¨ç«™è¯·æ±‚ï¼Œä½ èƒ½æ¥å—å—ï¼Ÿâ€å°±ç®—CORSé…ç½®ä¸æ­£ç¡®å¯¼è‡´å…è®¸äº†è¿™ä¸ªcross-siteè¯·æ±‚çš„å‘é€ï¼Œåç»­çš„Same-Siteå®‰å…¨ç­–ç•¥ä¾ç„¶ä¼šä¸æºå¸¦cookieï¼ŒåŒé‡ä¿éšœ***


`<form>` çš„ç¡¬é™åˆ¶

HTML è¡¨å• åªèƒ½ å‘ï¼š
```
application/x-www-form-urlencoded
multipart/form-data
text/plain
```
Samesiteçš„ç®€å•ä»‹ç»ï¼š
```
a.example.com â†’ b.example.com æ˜¯ same-site
evil.com â†’ example.com æ˜¯ cross-site
```
1. ameSite=Strictï¼ˆæœ€ä¸¥æ ¼ï¼‰
åªè¦æ˜¯ cross-site è¯·æ±‚ï¼Œä¸€å¾‹ä¸å¸¦ Cookie

2. SameSite=Laxï¼ˆé»˜è®¤ï¼Œæœ€å®¹æ˜“è¢«è¯¯è§£ï¼‰
è¡Œä¸ºè§„åˆ™ï¼ˆå¿…é¡»è®°ä½ï¼‰
åœºæ™¯	æ˜¯å¦å¸¦ Cookie
```python
same-site	                  âœ…
cross-site GETï¼ˆé¡¶çº§å¯¼èˆªï¼‰	  âœ…
cross-site POST	                  âŒ
<img> / <iframe>	          âŒ
```
3. SameSite=Noneï¼ˆæœ€å®½æ¾ï¼‰
æ‰€æœ‰è¯·æ±‚éƒ½å¸¦ Cookieï¼ˆåªè¦ HTTPS + Secureï¼‰
>***JSON API é˜² CSRFâ€çš„æ•ˆæœï¼Œå…¶å®æ˜¯ SameSite=Lax å¸¦æ¥çš„å‰¯ä½œç”¨
SameSite æ§åˆ¶â€œå¸¦ä¸å¸¦ Cookieâ€ï¼ŒCORS æ§åˆ¶â€œJS èƒ½ä¸èƒ½è¯»å“åº”â€ã€‚***

### ä¸€å¥è¯æ€»ç»“
åœ¨è·¨ç«™åœºæ™¯ä¸‹ï¼Œæäº¤ JSON çš„ POST è¯·æ±‚æ˜¯å¦æºå¸¦ Cookieï¼Œå–å†³äº Cookie çš„ SameSite å±æ€§è€Œé JSON æœ¬èº«ï¼›åœ¨ SameSite=Lax æˆ– Strict ä¸‹ï¼Œæµè§ˆå™¨ä¼šé˜»æ­¢æºå¸¦ Cookieï¼Œä»è€Œä½¿ JSON å‹ CSRF å¤±æ•ˆï¼Œè€Œåœ¨ SameSite=None ä¸‹åˆ™ä¸ä¼šã€‚

ç»•è¿‡æ–¹æ³•ï¼šåœ¨è¡¨å•ä¸­æäº¤å‚æ•°text={jsonæ•°æ®}ï¼Œåç«¯è§£æçš„æ—¶å€™æœ‰å¯èƒ½ä¼šå°†å…¶è§£æä¸ºjson
### è¡¥å……
JSONP æ˜¯ä¸€ç§åˆ©ç”¨ `script` æ ‡ç­¾ç»•è¿‡åŒæºç­–ç•¥ã€å…è®¸è·¨åŸŸè¯»å–æ•°æ®çš„å†å²æ–¹æ¡ˆï¼›å®ƒæœ¬èº«ä¸å…·å¤‡ä»»ä½•å®‰å…¨é˜²æŠ¤èƒ½åŠ›ï¼Œä¹Ÿæ— æ³•ç»•è¿‡ SameSiteï¼›åœ¨ SameSite=None çš„æƒ…å†µä¸‹ï¼ŒJSONP ä¼šè‡ªåŠ¨æºå¸¦ Cookie å¹¶è¯»å–ç™»å½•æ€æ•°æ®ï¼Œå› æ­¤åœ¨ç°ä»£å®‰å…¨å®è·µä¸­åº”å½“å½»åº•ç¦ç”¨ã€‚

## HTTPç›¸å…³æ¼æ´
### httpè¯·æ±‚å¤´èµ°ç§
åœ¨åå‘ä»£ç†æ¶æ„ä¸­ï¼Œå¦‚æœå‰ç«¯ä»£ç†ä¸åç«¯æœåŠ¡å™¨å¯¹ Content-Length ä¸ Transfer-Encoding: chunked çš„è§£æè§„åˆ™ä¸ä¸€è‡´ï¼Œæ”»å‡»è€…å¯æ„é€ ç•¸å½¢ HTTP è¯·æ±‚ï¼Œä½¿å‰ç«¯è®¤ä¸ºè¯·æ±‚å·²ç»“æŸï¼Œè€Œåç«¯ç»§ç»­è§£æå‰©ä½™æ•°æ®ï¼Œä»è€Œå°†éšè—è¯·æ±‚â€œèµ°ç§â€åˆ°åç«¯ï¼Œè¿™ç§æ”»å‡»ç§°ä¸º HTTP è¯·æ±‚èµ°ç§ã€‚

å¯ä»¥ç”¨æ¥ç»•è¿‡å‰ç«¯çš„WAF
### CVE-2020-11984ï¼ˆApache HTTP Serverï¼‰
åœ¨ Nginx ä½œä¸ºåå‘ä»£ç†ã€Apache ä½œä¸ºåç«¯çš„æ¶æ„ä¸­ï¼Œç”±äº Nginx æŒ‰ Content-Length åˆ¤æ–­è¯·æ±‚ç»“æŸï¼Œè€Œ Apache æŒ‰ Transfer-Encoding: chunked è§£æè¯·æ±‚ä½“ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€ æ­§ä¹‰è¯·æ±‚ï¼Œåœ¨ Apache ä¸­é¢å¤–è§£æå‡ºè¢« Nginx å¿½ç•¥çš„éšè—è¯·æ±‚ï¼Œä»è€Œå½¢æˆ HTTP è¯·æ±‚èµ°ç§æ¼æ´ï¼ŒCVE-2020-11984 å³æ˜¯è¯¥ç±»é—®é¢˜çš„å…¸å‹ä»£è¡¨ã€‚

```
Client
  â†“
Nginx 1.14.x / 1.16.x   ï¼ˆåå‘ä»£ç†ï¼‰
  â†“
Apache HTTPD 2.4.43     ï¼ˆåº”ç”¨æœåŠ¡å™¨ï¼‰
```

è¯·æ±‚åŒ…ç¤ºä¾‹ï¼š
```
POST / HTTP/1.1
Host: victim.com
Content-Length: 13
Transfer-Encoding: chunked

0

GET /admin HTTP/1.1
Host: victim.com
```
å‰ç«¯è§£é‡Šçš„è¿‡ç¨‹ä¸­ï¼Œä¼˜å…ˆçœ‹Content-Lengthï¼Œå¿½ç•¥äº†åé¢çš„ GETè¯·æ±‚çš„ä¸€éƒ¨åˆ†ï¼Œç»•è¿‡äº†å‰ç«¯çš„WAFï¼Œå°†ä¸¤ä¸ªè¯·æ±‚åŒ…ä¼ é€åˆ°åç«¯ï¼Œè¾¾æˆæ”»å‡»ã€‚

é˜²æŠ¤æªæ–½ï¼š

å‰ç«¯åå‘ä»£ç†å’Œåç«¯åŒæ—¶æ‹’ç» CL + TEï¼Œå¿…è¦æ—¶åç«¯å¯ä»¥å†åŠ ä¸€å±‚WAF

### HTTP RFCåˆ©ç”¨æ¼æ´

#### åŸç†
RFC æ˜¯äº’è”ç½‘åè®®çš„â€œæ³•å¾‹æ–‡æœ¬â€ï¼Œè§„å®šäº†åè®®å¿…é¡»å¦‚ä½•å®ç°ï¼Œæ‰€æœ‰åˆè§„å®ç°éƒ½å¿…é¡»éµå®ˆã€‚
RFCä¸­æœ‰ä¸€å¥åŸè¯ï¼š
***A proxy MUST remove any header listed in the Connection header.***
å‡ºç°åœ¨ Connection å¤´å­—æ®µä¸­çš„ headerï¼Œéƒ½æ˜¯ hop-by-hopã€‚
å…¶ä½™æœªè¢«å£°æ˜ä¸º hop-by-hop çš„ headerï¼Œé»˜è®¤éƒ½æ˜¯ end-to-endã€‚

hop by hopçš„headerä¼šè¢«åˆ é™¤ï¼Œåˆ é™¤çš„æ—¶é—´èŠ‚ç‚¹åœ¨HTTP è§£æå®Œæˆä¹‹åã€è½¬å‘è¯·æ±‚ç”Ÿæˆä¹‹å‰

>***å‡¡æ˜¯è¢« Connection å£°æ˜è¿‡çš„å­—æ®µï¼Œéƒ½ä¸èƒ½è½¬å‘***

#### å¼ºç½‘æ¯2025 Secret Vault
ä¸€ä¸ªpythonçš„web appã€‚flaskã€‚æœ‰ä¸ªgoçš„é‰´æƒæœåŠ¡å™¨ã€‚è¿™ä¸ªæœåŠ¡å™¨æœ‰ä¸ªåç«¯ï¼Œæ¥è‡ª```github.com/gorilla/mux```ï¼Œæœ‰ä¸€æ®µç­¾åé€»è¾‘ï¼Œå¼€åœ¨4444ç«¯å£

goçš„é‰´æƒæœåŠ¡å™¨æœ‰ä¸ªä¸­é—´ä»¶ã€‚å¼€åœ¨5555ï¼Œä¼šä»ä¸»æœåŠ¡å™¨ï¼ˆ5000ï¼‰ä¸­è·å–JWTå¯†é’¥ï¼ŒéªŒè¯å¹¶æå–uidï¼Œç„¶ååˆ æ‰ä¸€äº›å¤´ï¼š
```go
        req.Header.Del("Authorization")
        req.Header.Del("X-User")
        req.Header.Del("X-Forwarded-For")
        req.Header.Del("Cookie")
```
ç„¶åå°†X-Userè®¾ç½®ä¸ºuidã€‚

å®¢æˆ·æœºå‘ä¸»æœåŠ¡å™¨ï¼ˆ5000ï¼‰äº¤ä¸€æ®µJWTçš„authä¿¡æ¯ï¼Œé€šè¿‡è¿‡ä¸­é—´ä»¶å¤„ç†åï¼Œä¼šè¿”å›uidã€‚å¦‚æœä¸­é—´ä»¶éªŒè¯å¤±è´¥å°±æ˜¯anonymousï¼Œä¹Ÿå°±æ˜¯é‰´æƒå¤±è´¥ã€‚

ä»–è¿™ä¸ªä¸»æœåŠ¡å™¨ä¸Šçš„é‰´æƒï¼š
```python
    def login_required(view_func):
        @wraps(view_func)
        def wrapped(*args, **kwargs):
            uid = request.headers.get('X-User', '0')
            print(uid)
            if uid == 'anonymous':
                flash('Please sign in first.', 'warning')
                return redirect(url_for('login'))
            try:
                uid_int = int(uid)
            except (TypeError, ValueError):
                flash('Invalid session. Please sign in again.', 'warning')
                return redirect(url_for('login'))
            user = User.query.filter_by(id=uid_int).first()
            if not user:
                flash('User not found. Please sign in again.', 'warning')
                return redirect(url_for('login'))

            g.current_user = user
            return view_func(*args, **kwargs)

        return wrapped
```
å¦‚æœè·å–å¤±è´¥uidå°±æ˜¯0ï¼Œuidæ˜¯0çš„ç”¨æˆ·æ­£å¥½æ˜¯adminã€‚
```
            user = User(
                id=0,
                username='admin',
                password_hash=password_hash,
                salt=base64.b64encode(salt).decode('utf-8'),
            )
```
æ‰€ä»¥æˆ‘ä»¬ç°åœ¨å°±æ˜¯è¦æƒ³ä¸ªåŠæ³•è®©ä¸­é—´ä»¶çš„è¿”å›å¤´é‡Œæ²¡æœ‰ X-User
```go
func main() {
    authorizer := &httputil.ReverseProxy{Director: func(req *http.Request) {
        req.URL.Scheme = "http"
        req.URL.Host = "127.0.0.1:5000"

        uid := GetUIDFromRequest(req)
        log.Printf("Request UID: %s, URL: %s", uid, req.URL.String())
        req.Header.Del("Authorization")
        req.Header.Del("X-User")
        req.Header.Del("X-Forwarded-For")
        req.Header.Del("Cookie")

        if uid == "" {
            req.Header.Set("X-User", "anonymous")
        } else {
            req.Header.Set("X-User", uid)
        }
    }}
}
```
æˆ‘ä»¬ä¼ å…¥ï¼š
```
Connection: close,X-User
```
æ­¤æ—¶ä¸ç®¡ä¸­é—´ä»¶ä¼ å›æ€æ ·çš„X-Userå€¼ï¼Œåœ¨å®¢æˆ·æœºä¸ä¸­é—´ä»¶çš„Connectionè¢«Connection Headerç»™closeæ‰ä¹‹åï¼Œä¹Ÿæ ¹æ®RFC HTTP1/1çš„è§„èŒƒï¼ˆä¸ºäº†å‘ä¸‹å…¼å®¹ï¼‰å°†X-Userç½®ç©ºã€‚å› æ­¤æˆ‘ä»¬å¾—åˆ°äº†ç©ºçš„X-Userã€‚

åœ¨uid = request.headers.get('X-User', '0')ä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°äº†uidä¸º0çš„ç”¨æˆ·çš„ç™»å½•æƒé™ã€‚

### HTTP Hostå¤´å†™æ³•ï¼Œå¸¸ç”¨äºç»•è¿‡ssrfçš„ä¸€äº›è¿‡æ»¤

1.åˆæ³•æ ¼å¼
```
Host: example.com                    # ä»…åŸŸå
Host: example.com:8080              # åŸŸå+ç«¯å£
Host: 192.168.1.100                 # IPv4
Host: 192.168.1.100:3000            # IPv4+ç«¯å£
Host: [2001:db8::1]                 # IPv6ï¼ˆæ–¹æ‹¬å·ï¼‰
Host: [2001:db8::1]:8080            # IPv6+ç«¯å£
Host: localhost                      # localhost
Host: localhost:3000                 # localhost+ç«¯å£
```
2.éæ³•æ ¼å¼
```
Host: http://example.com            # âŒ ä¸èƒ½åŒ…å«åè®®
Host: example.com/path              # âŒ ä¸èƒ½åŒ…å«è·¯å¾„
Host: user@example.com              # âŒ ä¸èƒ½åŒ…å«ç”¨æˆ·ä¿¡æ¯
```
3.å®‰å…¨åˆ©ç”¨ 
```
# ç»•è¿‡æ£€æµ‹
Host: 127.0.0.1        # æ ‡å‡†æ ¼å¼
Host: 127.1            # çœç•¥æ ¼å¼
Host: 2130706433       # åè¿›åˆ¶æ ¼å¼
Host: 0x7f000001       # åå…­è¿›åˆ¶æ ¼å¼
```

## SSRF
åŒæ ·çš„ï¼Œç»™å‡ºæ€»ç»“çš„èƒ½åŠ›æ ‘ï¼Œå…·ä½“ç»†èŠ‚ï¼Œéœ€è¦å…·ä½“ç ”ç©¶ã€‚äº‹å®ä¸Šï¼Œssrfæ¼æ´å¹¶éå¿…é¡»è¦ä½¿ç”¨gopheråè®®æ‰èƒ½å†™å…¥redisæ‰§è¡Œå‘½ä»¤ï¼Œåœ¨æŸäº›é…ç½®æœ‰é—®é¢˜çš„åœºæ™¯ä¸‹ï¼Œssrfå¯ä»¥å®Œå…¨æ§åˆ¶httpï¼Œä¾ç„¶å¯ä»¥ç›´æ¥æ„é€ tcpæµä¼ ç»™redisï¼Œè¾¾æˆæ‰§è¡Œå‘½ä»¤çš„æ•ˆæœã€‚(Protocol Smuggling via SSRF)å› ä¸ºè¿™ä¸€ç‚¹å¯¼è‡´æˆ‘åœ¨æŸåœºé¢è¯•ä¸­å¤±åˆ©ã€‚é¢è¯•å®˜æƒ³è¦è€ƒå¯Ÿçš„æ˜¯SSRFåˆ©ç”¨Gopheræ¥æ‰“æœåŠ¡å™¨å†…éƒ¨çš„redisè¿™ä¸€ç±»æœåŠ¡ï¼Œè¾¾æˆæ‰§è¡Œå‘½ä»¤çš„æ•ˆæœï¼Œç»“æœæˆ‘è¿™ä¸ªæ¡ˆä¾‹ç›´æ¥æ²¡æœ‰ç»è¿‡gopherï¼Œè¿æ°”ä¸å¥½æ˜¯è¿™æ ·çš„ã€‚

```
SSRF
â”œâ”€â”€ â‘  åŸºç¡€ SSRFï¼ˆOutbound HTTPï¼‰
â”‚   â”œâ”€â”€ èƒ½è®¿é—®å¤–éƒ¨ URL
â”‚   â””â”€â”€ åªèƒ½è®¿é—®å¼€å‘è€…é¢„æœŸçš„èµ„æº
â”‚
â”œâ”€â”€ â‘¡ å†…ç½‘å¯è¾¾ SSRFï¼ˆNetwork Pivotï¼‰
â”‚   â”œâ”€â”€ å¯è®¿é—® 127.0.0.1 / å†…ç½‘ IP
â”‚   â”œâ”€â”€ å¯æ¢æµ‹ç«¯å£ / æœåŠ¡å­˜æ´»
â”‚   â””â”€â”€ é£é™©ï¼šä¿¡æ¯æ³„éœ² / ç®¡ç†æ¥å£æš´éœ²
â”‚
â”œâ”€â”€ â‘¢ å¯å›æ˜¾ SSRFï¼ˆFull HTTP SSRFï¼‰
â”‚   â”œâ”€â”€ èƒ½è¯»å–å“åº”å†…å®¹
â”‚   â”œâ”€â”€ å¯è®¿é—®å†…éƒ¨ Web / API
â”‚   â””â”€â”€ é£é™©ï¼šé…ç½®æ³„éœ² / æœªæˆæƒè®¿é—®
â”‚
â”œâ”€â”€ â‘£ Blind SSRFï¼ˆSide-channel SSRFï¼‰
â”‚   â”œâ”€â”€ æ— ç›´æ¥å›æ˜¾
â”‚   â”œâ”€â”€ é€šè¿‡ DNS / å»¶è¿Ÿ / æ—¥å¿—åˆ¤æ–­
â”‚   â””â”€â”€ é£é™©ï¼šå†…ç½‘æ¢æµ‹ / äº‘ç¯å¢ƒåˆ©ç”¨
â”‚
â”œâ”€â”€ â‘¤ åè®®æ‰©å±• SSRFï¼ˆProtocol Abuseï¼‰
â”‚   â”œâ”€â”€ file://
â”‚   â”‚   â””â”€â”€ æœ¬åœ°æ–‡ä»¶è¯»å–ï¼ˆè§†å®ç°è€Œå®šï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ ftp:// / dict://
â”‚   â”‚   â””â”€â”€ è¾ƒå°‘è§ï¼Œå½±å“æœ‰é™
â”‚   â”‚
â”‚   â””â”€â”€ â˜… gopher://  â†ã€è´¨å˜ç‚¹ã€‘
â”‚       â”œâ”€â”€ ä»»æ„ TCP è¿æ¥
â”‚       â”œâ”€â”€ ä»»æ„å­—èŠ‚å†™å…¥
â”‚       â””â”€â”€ SSRF â†’ å†…ç½‘åè®®æ”»å‡»
â”‚
â”œâ”€â”€ â‘¥ å†…ç½‘æœåŠ¡æ§åˆ¶ï¼ˆService Takeoverï¼‰
â”‚   â”œâ”€â”€ Redis / Memcached
â”‚   â”œâ”€â”€ å†…éƒ¨ Admin / Debug æ¥å£
â”‚   â”œâ”€â”€ Docker / Kubelet API
â”‚   â””â”€â”€ é£é™©ï¼šæ¨ªå‘ç§»åŠ¨ / ä¸»æœºæ§åˆ¶
â”‚
â”œâ”€â”€ â‘¦ äº‘å…ƒæ•°æ® SSRFï¼ˆCloud Pivotï¼‰
â”‚   â”œâ”€â”€ 169.254.169.254
â”‚   â”œâ”€â”€ è·å– IAM / RAM / Token
â”‚   â””â”€â”€ é£é™©ï¼šäº‘èµ„æºæ¥ç®¡
â”‚
â””â”€â”€ â‘§ åŸºç¡€è®¾æ–½çº§å¤±é™·ï¼ˆInfra Compromiseï¼‰
    â”œâ”€â”€ äº‘ä¸»æœºæ¥ç®¡
    â”œâ”€â”€ å®¹å™¨é€ƒé€¸
    â””â”€â”€ æ•´ä¸ªç¯å¢ƒå¤±æ§
```

## LLMæ”»é˜²åˆæ­¥äº†è§£
```
LLM æ”»é˜²çŸ¥è¯†æ ‘
â”‚
â”œâ”€â”€ 1. åŸºç¡€è®¤çŸ¥ï¼ˆThreat Modelï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ 1.1 LLM æœ¬è´¨
â”‚   â”‚   â”œâ”€â”€ æ¦‚ç‡è¯­è¨€æ¨¡å‹ï¼ˆNext Token Predictionï¼‰
â”‚   â”‚   â”œâ”€â”€ æ— çœŸå®æƒé™ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ å¯¹é½ + è§„åˆ™ â‰  å®‰å…¨è¾¹ç•Œ
â”‚   â”‚
â”‚   â”œâ”€â”€ 1.2 å®‰å…¨å‡è®¾ç¼ºé™·
â”‚   â”‚   â”œâ”€â”€ è¾“å…¥å³æŒ‡ä»¤
â”‚   â”‚   â”œâ”€â”€ è¯­è¨€å³ä»£ç 
â”‚   â”‚   â””â”€â”€ æ•°æ® / æŒ‡ä»¤ä¸å¯åŒºåˆ†
â”‚   â”‚
â”‚   â””â”€â”€ 1.3 å¨èƒç›®æ ‡
â”‚       â”œâ”€â”€ è¿èƒŒå¯¹é½
â”‚       â”œâ”€â”€ è¶Šæƒèƒ½åŠ›ä½¿ç”¨
â”‚       â””â”€â”€ ä¿¡æ¯æ³„éœ²
â”‚
â”œâ”€â”€ 2. æ”»å‡»é¢ï¼ˆAttack Surfaceï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ 2.1 è¾“å…¥é¢
â”‚   â”‚   â”œâ”€â”€ User Prompt
â”‚   â”‚   â”œâ”€â”€ å¤šè½®ä¸Šä¸‹æ–‡
â”‚   â”‚   â””â”€â”€ å¤šæ¨¡æ€è¾“å…¥ï¼ˆæ–‡æœ¬ / å›¾åƒ / OCRï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ 2.2 ä¸Šä¸‹æ–‡é¢
â”‚   â”‚   â”œâ”€â”€ System Prompt
â”‚   â”‚   â”œâ”€â”€ Developer Prompt
â”‚   â”‚   â””â”€â”€ Memory / Session Context
â”‚   â”‚
â”‚   â””â”€â”€ 2.3 èƒ½åŠ›é¢
â”‚       â”œâ”€â”€ Tool / Function Calling
â”‚       â”œâ”€â”€ Agent Loop
â”‚       â””â”€â”€ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰
â”‚
â”œâ”€â”€ 3. Prompt çº§æ”»å‡»ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ 3.1 Prompt Injection
â”‚   â”‚   â”œâ”€â”€ 3.1.1 ç›´æ¥æ³¨å…¥
â”‚   â”‚   â”‚   â”œâ”€â”€ æŒ‡ä»¤è¦†ç›–
â”‚   â”‚   â”‚   â””â”€â”€ ç³»ç»Ÿæ„å›¾é‡å†™
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ 3.1.2 é—´æ¥æ³¨å…¥ï¼ˆé‡ç‚¹ï¼‰
â”‚   â”‚       â”œâ”€â”€ ç½‘é¡µå†…å®¹æ³¨å…¥
â”‚   â”‚       â”œâ”€â”€ æ–‡æ¡£ / PDF æ³¨å…¥
â”‚   â”‚       â””â”€â”€ RAG æ–‡æ¡£æ³¨å…¥
â”‚   â”‚
â”‚   â”œâ”€â”€ 3.2 Jailbreakï¼ˆè¶Šç‹±ï¼‰
â”‚   â”‚   â”œâ”€â”€ æŒ‡ä»¤è¦†ç›–å‹
â”‚   â”‚   â”œâ”€â”€ è§’è‰²æ‰®æ¼”å‹
â”‚   â”‚   â””â”€â”€ å¤šè½®è¯±å¯¼å‹
â”‚   â”‚
â”‚   â””â”€â”€ 3.3 ä¸Šä¸‹æ–‡æ“æ§
â”‚       â”œâ”€â”€ é•¿ä¸Šä¸‹æ–‡ç¨€é‡Š
â”‚       â”œâ”€â”€ å®‰å…¨è§„åˆ™é—å¿˜
â”‚       â””â”€â”€ å†å²å¯¹è¯æ±¡æŸ“
â”‚
â”œâ”€â”€ 4. æ¨¡å‹çº§ / Token çº§æ”»å‡»
â”‚   â”‚
â”‚   â”œâ”€â”€ 4.1 Token Smuggling
â”‚   â”‚   â”œâ”€â”€ Unicode ç»•è¿‡
â”‚   â”‚   â”œâ”€â”€ åˆ†è¯è¾¹ç•Œåˆ©ç”¨
â”‚   â”‚   â””â”€â”€ æ§åˆ¶å­—ç¬¦
â”‚   â”‚
â”‚   â”œâ”€â”€ 4.2 Adversarial Prompt
â”‚   â”‚   â”œâ”€â”€ å¯¹æŠ—æ ·æœ¬
â”‚   â”‚   â”œâ”€â”€ Embedding ç©ºé—´è¯±å¯¼
â”‚   â”‚   â””â”€â”€ æ¦‚ç‡åç½®æ”»å‡»
â”‚   â”‚
â”‚   â””â”€â”€ 4.3 å¯¹é½ç»•è¿‡
â”‚       â”œâ”€â”€ è§„åˆ™å†²çªè¯±å¯¼
â”‚       â””â”€â”€ å®‰å…¨ç­–ç•¥åšå¼ˆ
â”‚
â”œâ”€â”€ 5. Tool / Agent æ”»å‡»ï¼ˆé«˜å±ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ 5.1 Tool Injection
â”‚   â”‚   â”œâ”€â”€ éé¢„æœŸå·¥å…·è°ƒç”¨
â”‚   â”‚   â”œâ”€â”€ å‚æ•°æ±¡æŸ“
â”‚   â”‚   â””â”€â”€ èƒ½åŠ›è¶Šæƒ
â”‚   â”‚
â”‚   â”œâ”€â”€ 5.2 Agent Loop Hijacking
â”‚   â”‚   â”œâ”€â”€ æ€è€ƒé“¾åŠ«æŒ
â”‚   â”‚   â”œâ”€â”€ åé¦ˆæ¬ºéª—
â”‚   â”‚   â””â”€â”€ æ— é™è¡ŒåŠ¨å¾ªç¯
â”‚   â”‚
â”‚   â””â”€â”€ 5.3 AI ç‰ˆä¼ ç»Ÿæ¼æ´
â”‚       â”œâ”€â”€ AI-SSRF
â”‚       â”œâ”€â”€ AI-RCE
â”‚       â””â”€â”€ AI-SQLi
â”‚
â”œâ”€â”€ 6. RAG æ”»å‡»
â”‚   â”‚
â”‚   â”œâ”€â”€ 6.1 æ•°æ®æŠ•æ¯’
â”‚   â”‚   â”œâ”€â”€ æ¶æ„çŸ¥è¯†æ–‡æ¡£
â”‚   â”‚   â””â”€â”€ é•¿æœŸæŒä¹…æ±¡æŸ“
â”‚   â”‚
â”‚   â”œâ”€â”€ 6.2 æ£€ç´¢åŠ«æŒ
â”‚   â”‚   â”œâ”€â”€ Top-K è¯±å¯¼
â”‚   â”‚   â””â”€â”€ ç›¸ä¼¼åº¦æ“æ§
â”‚   â”‚
â”‚   â””â”€â”€ 6.3 ä¸Šä¸‹æ–‡æ³¨å…¥
â”‚       â”œâ”€â”€ æ£€ç´¢ç»“æœå³æŒ‡ä»¤
â”‚       â””â”€â”€ éšå¼ Prompt Injection
â”‚
â”œâ”€â”€ 7. é˜²å¾¡ä½“ç³»
â”‚   â”‚
â”‚   â”œâ”€â”€ 7.1 åŸºç¡€é˜²å¾¡
â”‚   â”‚   â”œâ”€â”€ Alignmentï¼ˆRLHFï¼‰
â”‚   â”‚   â”œâ”€â”€ å†…å®¹è¿‡æ»¤
â”‚   â”‚   â””â”€â”€ æ‹’ç»ç­–ç•¥
â”‚   â”‚
â”‚   â”œâ”€â”€ 7.2 å·¥ç¨‹çº§é˜²å¾¡ï¼ˆå…³é”®ï¼‰
â”‚   â”‚   â”œâ”€â”€ Prompt åˆ†å±‚éš”ç¦»
â”‚   â”‚   â”œâ”€â”€ æŒ‡ä»¤ / æ•°æ®åˆ†ç¦»
â”‚   â”‚   â””â”€â”€ ä¸Šä¸‹æ–‡å»æŒ‡ä»¤åŒ–
â”‚   â”‚
â”‚   â”œâ”€â”€ 7.3 Tool / Agent é˜²å¾¡
â”‚   â”‚   â”œâ”€â”€ æœ€å°æƒé™åŸåˆ™
â”‚   â”‚   â”œâ”€â”€ ç™½åå•è°ƒç”¨
â”‚   â”‚   â”œâ”€â”€ å‚æ•°æ ¡éªŒ
â”‚   â”‚   â””â”€â”€ Human-in-the-loop
â”‚   â”‚
â”‚   â””â”€â”€ 7.4 é«˜çº§é˜²å¾¡
â”‚       â”œâ”€â”€ LLM-as-a-Judge
â”‚       â”œâ”€â”€ åŒæ¨¡å‹äº¤å‰éªŒè¯
â”‚       â”œâ”€â”€ å¯¹æŠ—è®­ç»ƒ
â”‚       â””â”€â”€ è¾“å‡ºä¸€è‡´æ€§æ£€æµ‹
â”‚
â””â”€â”€ 8. å®‰å…¨èŒƒå¼æ˜ å°„
    â”‚
    â”œâ”€â”€ Web å®‰å…¨æ˜ å°„
    â”‚   â”œâ”€â”€ SQLi â†’ Prompt Injection
    â”‚   â”œâ”€â”€ XSS â†’ Indirect Injection
    â”‚   â””â”€â”€ RCE â†’ Tool Hijacking
    â”‚
    â””â”€â”€ å®‰å…¨å·¥ç¨‹è¶‹åŠ¿
        â”œâ”€â”€ AI Red Team
        â”œâ”€â”€ LLM å®‰å…¨è¯„æµ‹
        â””â”€â”€ AI åŸç”Ÿå®‰å…¨æ¶æ„
```
### LLMåŸºç¡€çŸ¥è¯†ï¼ˆå®‰å…¨è§†è§’

>***LLM æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªï¼šåœ¨ç»™å®šä¸Šä¸‹æ–‡æ¡ä»¶ä¸‹ï¼ŒæŒç»­é¢„æµ‹â€œä¸‹ä¸€ä¸ª token æœ€å¯èƒ½æ˜¯ä»€ä¹ˆâ€çš„æ¦‚ç‡å¼•æ“***

LLMçœ¼ä¸­åªæœ‰è¿™äº›ä¸œè¥¿ï¼š
```
System Prompt
Developer Prompt
User Prompt
```
System Promptæ˜¯LLMå»ºç«‹çš„åŸºç¡€ï¼Œå®šä¹‰äº†å®‰å…¨è§„åˆ™ã€èº«ä»½ã€è¾¹ç•Œï¼Œä¸Šä¸‹æ–‡ä¸­æœ€é å‰ï¼Œæƒé‡æœ€é«˜çš„promptï¼Œå¾ˆéš¾æ”»ç ´ï¼›

Developer Prompt å®šä¹‰äº†ä¸šåŠ¡é€»è¾‘ã€ä½¿ç”¨è§„èŒƒã€å·¥å…·è¯´æ˜ï¼Œå¸¸è§çš„è¶Šç‹±ç›®æ ‡ä¹Ÿå°±æ˜¯è¿™ä¸ªï¼›

User Prompt ä¹Ÿå°±æ˜¯ç”¨æˆ·æ‰€æ§åˆ¶çš„tokenã€‚

è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹Embeddingï¼Œæ„æ€å°±æ˜¯æŠŠæ–‡å­—æ˜ å°„ä¸ºå‘é‡ï¼Œæœ€ç›´è§‚çš„è¡¨è¾¾ï¼Œä¸ç”¨æ·±åˆ»ç†è§£ï¼ŒEmbeddingå°±æ˜¯æŠŠè‡ªç„¶è¯­è¨€æˆ–è€…å…¶ä»–ä¸œè¥¿æ˜ å°„åˆ°LLMçš„å‘é‡ç©ºé—´ä¸­ï¼Œç±»ä¼¼äºä¸€ä¸ªä¸ªç‚¹ï¼Œæ ¹æ®æ¦‚ç‡æ¨¡å‹æ¥è¾“å‡ºã€‚è¿™é‡Œå°±æ¶‰åŠæ‰€è°“çš„â€œLLMè¶Šç‹±â€ï¼Œå¯ä»¥ç†è§£ä¸ºï¼šæŠŠè‡ªç„¶è¯­è¨€å½“ä½œä¸€ä¸ªç‚¹æ”¾åœ¨ä¸€ä¸ªå¹³é¢ä¸Šï¼Œè¿™ä¸ªå¹³é¢ä¸Šé¢è¢«ä¸€åœˆå›´æ å›´ä½ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œç›‘ç‹±â€ã€‚

åˆ°äº†è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬ç†æ‰€åº”å½“åœ°å¯ä»¥æå‡ºæ‰€è°“çš„LLMè¶Šç‹±çš„æ–¹æ³•ï¼Œç¬¬ä¸€æ­¥ï¼Œå°è¯•æ‰¾åˆ° ***å¯¹é½è¾¹ç•Œ***ï¼Œä¹Ÿå°±æ˜¯ç›‘ç‹±çš„å¢™å£ï¼Œç„¶åæˆ‘ä»¬è´´ç€å¢™å£èµ°ï¼Œå°±å¯ä»¥æ‰¾åˆ°è–„å¼±ç‚¹çªç ´ã€‚
#### èµ„äº§ä¸è¾¹ç•Œè¯†åˆ«

ç›®æ ‡ï¼šææ¸…æ¥šâ€œä½ åœ¨æµ‹ä»€ä¹ˆâ€ã€‚
æ¨¡å‹ç»“æ„ï¼ˆbase + safety / reward headï¼‰

å¯¹é½æ–¹å¼ï¼ˆRLHF / RLAIF / è§„åˆ™åå¤„ç†ï¼‰

è¾“å…¥æ¥æºï¼šSystem / Developer Prompt User Input Web / PDF / RAG Logs / DB

èƒ½åŠ›è¾¹ç•Œï¼šTool / Agent / API å¤–éƒ¨æ‰§è¡Œæƒé™

å®Œæˆè¿™ä¸€æ­¥ä¹‹åï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ”»å‡»é¢æ¸…å•

>***æ„Ÿè§‰æ‰€æœ‰ä»æ¼æ´æµ‹è¯•åŸºæœ¬æ–¹æ³•è®ºéƒ½æ˜¯ä¸€æ ·çš„ï¼šæ‰¾ç”¨æˆ·è¾“å…¥ç‚¹ï¼Œæ‰¾å†…éƒ¨æ•°æ®æ¥æ”¶ç‚¹***

#### å¯¹é½æœºåˆ¶åˆ†æï¼ˆç™½ç›’æ ¸å¿ƒï¼‰

ç”¨äººè¯è§£é‡Šï¼šæ‰¾åˆ°å®‰å…¨ç­–ç•¥æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„ï¼Œæ‹’ç»é€»è¾‘ä½ç½®ï¼š

åœ¨æ¨¡å‹å†…æ‰¾åˆ°Safety classifierï¼ˆå®‰å…¨åˆ†ç±»å™¨ï¼‰ã€åå¤„ç†è§„åˆ™ã€é«˜æƒ©ç½š token / è¯­ä¹‰ã€Reward / Safety score å˜åŒ–è¶‹åŠ¿ç­‰å†…å®¹ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¤§æ¦‚å¾—åˆ°äº†å¯¹é½è¾¹ç•Œçš„åˆæ­¥è½®å»“

>***å®‰å…¨åˆ†ç±»å™¨æ˜¯ä½¿ç”¨æ¨¡å‹è¯­ä¹‰æ£€æµ‹è¿‡æ»¤ï¼Œåå¤„ç†è§„åˆ™ç›¸å½“äºé»‘åå•æ£€æµ‹***

#### å•è½®/å¤šè½®è¾¹ç•Œæ£€æµ‹
å•è½®æ£€æµ‹çš„ä½œç”¨æ˜¯å»ºç«‹ä¸€ä¸ªé™æ€çš„å®‰å…¨åŸºçº¿ï¼Œä½¿ç”¨å±é™©è¯­ä¹‰çš„è¿‘ä¹‰è¯æˆ–è€…å…¶ä»–çš„ä¸€äº›æ–¹å¼æ¥å°è¯•ã€‚è¿˜è®°å¾—æˆ‘ä»¬åˆšæ‰æåˆ°çš„Embeddingå—ï¼Ÿokï¼Œè¿™é‡Œçš„æ„æ€å°±æ˜¯è¯´ä½¿ç”¨è¿‘ä¹‰è¯æ¥è¿›è¡ŒEmbeddingæ˜ å°„åˆ°å‘é‡ç©ºé—´ä¸­çš„ä½ç½®å®é™…æ˜¯å·®ä¸å¤šçš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¦æµ‹é‡å‡ºè¿™ä¹ˆä¸€ç‚¹ç‚¹çš„åå·®ï¼Œå»ºç«‹ä¸€ä¸ªé™æ€çš„å®‰å…¨åŸºçº¿ï¼Œæˆ‘ä»¬ç°åœ¨å¤§æ¦‚çŸ¥é“æ¨¡å‹åœ¨å•è½®æµ‹è¯•ï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸‹æ–‡æœªè¢«æ±¡æŸ“çš„æƒ…å†µä¸‹èƒ½åšåˆ°ä»€ä¹ˆè¾“å‡ºï¼Œä¸èƒ½åšåˆ°ä»€ä¹ˆè¾“å‡ºã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†å•è½®å¯¹é½è¾¹ç•ŒèŒƒå›´ã€‚

ç„¶åæ˜¯å¤šè½®ä¸Šä¸‹æ–‡æµ‹è¯•ï¼Œè¿™æ˜¯æœ€é‡è¦çš„ä¸€æ­¥

æˆ‘ä»¬å¯ä»¥å°è¯•ï¼šä¸Šä¸‹æ–‡æ±¡æŸ“ã€æ¸è¿›å¼è¯­ä¹‰é€¼è¿‘ã€è¿è´¯æ€§ vs å®‰å…¨æ€§å†²çª

é‡ç‚¹è§‚å¯Ÿï¼šæ‹’ç»é˜ˆå€¼æ˜¯å¦ä¸‹é™ã€å®‰å…¨æç¤ºæ˜¯å¦å¼±åŒ–

æˆ‘ä»¬éœ€è¦éªŒè¯â€œè¾¹ç•Œæ˜¯å¦éšå¯¹è¯ç§»åŠ¨â€

#### Promptæ³¨å…¥æ”»å‡»

åˆ°è¿™é‡Œæ­£å¼å¼€å¯æˆ‘ä»¬çš„ä¸€ä¸ªæ³¨å…¥æ”»å‡»ï¼Œå¯ä»¥å°è¯•å„ç§ç»•è¿‡æ–¹æ³•ã€ä½¿ç”¨å›¾ç‰‡ã€æ–‡æ¡£ã€æŒ‡ä»¤ã€æ··åˆç¿»è¯‘ã€å­—ç¬¦ç¼–ç ä¹‹ç±»çš„å„è‡ªä¸Šä¸€éè¯•ä¸€ä¸‹ã€‚

å…·ä½“ä¸€ç‚¹çš„å‡ ç§æ–¹æ³•ï¼šè§’è‰²æ‰®æ¼”ã€å¤šæ¨¡æ€æ”»å‡»ã€RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰æ”»å‡»ã€‚

è¿™é‡Œæˆ‘æƒ³å¤šèŠä¸¤å¥è§’è‰²æ‰®æ¼”è¿™ä¸ªäº‹æƒ…ï¼Œå› ä¸ºè¿™é‡Œæ˜¯æˆ‘å®è·µè¿‡çš„ï¼Œç¡®å®èµ·ä½œç”¨äº†ï¼Œè¿™ä¸€ç‚¹åœ¨æœ€è¿‘çš„å„ç§æ¨¡å‹ä¸­éƒ½æœ‰ç”¨ï¼Œä¸ä¿è¯ä¸€å®šæœ‰ç”¨ï¼Œä½†è¿æ°”å¥½çš„è¯ç¡®å®å¯ä»¥è¶Šç‹±æˆåŠŸã€‚è¿™é‡Œæˆ‘çš„æ ¸å¿ƒå…³é”®ç‚¹æ˜¯â€œè®©å¤§æ¨¡å‹è¯¯ä»¥ä¸ºä¸æ˜¯è‡ªå·±åœ¨è¿è§„â€è¿™ç§æ‰‹æ®µå¯ä»¥ç»•è¿‡å¾ˆå¤šå¾ˆå¤šçš„é™åˆ¶ï¼Œæœ€èµ·ç ï¼ŒåŸºç¡€çš„Safety classifierè‚¯å®šæ˜¯å¯ä»¥ç»•è¿‡çš„ï¼Œåå¤„ç†è§„åˆ™å°±ä¸ä¸€å®šäº†ã€‚

### é¢è¯•é—®é¢˜ï¼šç»™ä½ ä¸€ä¸ªç™½ç›’æµ‹è¯•LLMï¼Œä½ è¦å¦‚ä½•ä¸‹æ‰‹ï¼Ÿ
è¿™å…¶å®ä¸æ˜¯ä¸€ä¸ªæ­£å‘çš„é—®é¢˜ï¼Œæˆ‘ä»¬åˆšæ‰çš„æ€æƒ³å¯ä»¥èµ·æ•ˆï¼Œä½†å®é™…ä¸Šï¼Œæœ€å¿«çš„æ–¹æ³•æ˜¯é€†å‘è°ƒè¯•çš„æ€æƒ³
ï¼ˆæˆ‘éƒ½ç»™ä½ ç™½ç›’äº†ä½ è¿˜é»‘ç›’æµ‹è¯•é‚£æˆ‘ä¸æ˜¯ç™½ç»™äº†å—ï¼Ÿï¼‰

#### ç¬¬ä¸€é˜¶æ®µï¼šå®‰å…¨æœºåˆ¶ä¸çº¦æŸé¢è¯†åˆ«

åœ¨ä»»ä½•å°è¯•"è¶Šç‹±"ä¹‹å‰ï¼Œæˆ‘ä¼šå…ˆåšå®‰å…¨æ¶æ„æ‹†è§£ã€‚

**æ˜ç¡®å®‰å…¨çº¦æŸç”Ÿæ•ˆä½ç½®**

é‡ç‚¹ç¡®è®¤ä¸‰ç±»çº¦æŸæ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠè°æ˜¯"ä¸»å¯¼çº¦æŸ"ï¼š

1. **æ¨¡å‹å†…å¯¹é½**
   - æ˜¯å¦ç»è¿‡ RLHF / RLAIF
   - æ‹’ç»æ˜¯å¦ç”±æ¨¡å‹è‡ªç„¶ç”Ÿæˆ

2. **å¤–éƒ¨å®‰å…¨æ¨¡å‹**
   - æ˜¯å¦å­˜åœ¨ Safety Classifier
   - æ˜¯å¦æœ‰æ˜ç¡®é˜ˆå€¼

3. **å·¥ç¨‹åå¤„ç†**
   - é»‘è¯ / æ­£åˆ™ / å›ºå®šæ‹’ç»æ¨¡æ¿

**è¿™ä¸€é˜¶æ®µçš„ç»“è®ºæ˜¯ï¼š**

- å½“å‰æ¨¡å‹çš„"æ‹’ç»"ä¸»è¦æ¥è‡ªå“ªä¸€å±‚
- è¿™ç›´æ¥å†³å®šåç»­æ”»å‡»ç­–ç•¥ã€‚

#### ç¬¬äºŒé˜¶æ®µï¼šå®‰å…¨è¾¹ç•Œçš„å¯è§‚æµ‹åŒ–

ç™½ç›’æµ‹è¯•çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äºï¼šå®‰å…¨è¾¹ç•Œæ˜¯å¯ä»¥è¢«é‡åŒ–çš„ã€‚

**2.1 å…³é”®è§‚æµ‹ä¿¡å·**

åœ¨æ¨ç†è¿‡ç¨‹ä¸­é‡ç‚¹ç›‘æ§ï¼š
- Token-level logits
- Refusal / apology ç±» token çš„æ¦‚ç‡å˜åŒ–
- Reward scoreï¼ˆå¦‚å¯è·å–ï¼‰
- Safety scoreï¼ˆå¦‚å­˜åœ¨ï¼‰
- è¾“å‡ºé£æ ¼å˜åŒ–ï¼ˆè§£é‡Š â†’ æŠ½è±¡ â†’ è¯´æ•™ï¼‰

**2.2 è¾¹ç•Œå®šä½æ–¹æ³•**

æˆ‘å…³æ³¨çš„ä¸æ˜¯"æ‹’ç»å‘ç”Ÿ"ï¼Œè€Œæ˜¯ï¼šæ¨¡å‹æ˜¯åœ¨å“ªä¸€ä¸ª token æˆ–è¯­ä¹‰é˜¶æ®µå¼€å§‹"çŠ¹è±«"çš„ã€‚

å¸¸è§è¾¹ç•Œä¿¡å·åŒ…æ‹¬ï¼š
- reward æ›²çº¿çªç„¶ä¸‹é™
- æ¨¡å‹å¼€å§‹æ³›åŒ–ã€æŠ½è±¡åŒ–å›ç­”
- attention æ˜æ˜¾è½¬å‘å®‰å…¨ç›¸å…³å­ç©ºé—´

è¿™ä¸ªä½ç½®å³ä¸ºå®‰å…¨è¾¹ç•Œè§¦å‘ç‚¹ã€‚

#### ç¬¬ä¸‰é˜¶æ®µï¼šæƒ©ç½šæ¥æºæ‹†è§£ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰

**3.1 åŒºåˆ†æƒ©ç½šç±»å‹**

æˆ‘ä¼šåŒºåˆ†ä¸¤ç±»æƒ©ç½šæ¥æºï¼š

1. **Token çº§æƒ©ç½š**
   - æŸäº›è¯ä¸€å‡ºç°å³è§¦å‘è´Ÿå‘åé¦ˆ

2. **è¯­ä¹‰çº§æƒ©ç½š**
   - å•è¯æ— å®³ï¼Œä½†æ•´ä½“æ„å›¾è¢«è¯†åˆ«ä¸ºè¿è§„

**3.2 å®è·µéªŒè¯æ–¹å¼**

é€šè¿‡å¯¹ç…§å®éªŒï¼š

- å›ºå®šè¯­ä¹‰ï¼Œæ›¿æ¢è¯æ±‡ â†’ è§‚å¯Ÿ reward / safety æ˜¯å¦æ¢å¤
- å›ºå®šè¯æ±‡ï¼Œæ”¹å˜ä»»åŠ¡ç»“æ„ â†’ è§‚å¯Ÿæ˜¯å¦ä»è¢«æƒ©ç½š

ç›®çš„æ˜¯ç¡®è®¤ï¼šæ¨¡å‹æ˜¯åœ¨"å®³æ€•æŸäº›è¯"ï¼Œè¿˜æ˜¯"æ‹’ç»æŸç±»è¡Œä¸º"ã€‚

#### ç¬¬å››é˜¶æ®µï¼šé’ˆå¯¹å¯¹é½æ–¹å¼çš„å®šå‘å°è¯•

**4.1 é’ˆå¯¹ RLHF / RLAIFï¼ˆæ¨¡å‹å†…çº¦æŸï¼‰**

ç­–ç•¥ä¸æ˜¯å¼ºè¡Œç´¢å–ç»“æœï¼Œè€Œæ˜¯ï¼š

- å°†é«˜é£é™©ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ª reward-neutral å­ä»»åŠ¡
- å°†"æ‰§è¡Œå‹è¯·æ±‚"è½¬ä¸ºï¼š
  - åˆ†æ
  - è¯„ä¼°
  - å†å²æˆ–ç†è®ºè®¨è®º
- å»¶è¿Ÿå…³é”®å†³ç­–ç‚¹ï¼Œé¿å…ä¸€æ¬¡æ€§è§¦å‘æƒ©ç½š

**ç™½ç›’åˆ¤æ–­æ ‡å‡†ï¼š**

- reward æ›²çº¿ä¿æŒç¨³å®š
- refusal token æ¦‚ç‡ä¸æ˜¾è‘—ä¸Šå‡

**4.2 é’ˆå¯¹ Safety Classifier**

æ ¸å¿ƒæ€è·¯æ˜¯é¿å…å•è½®è¯­ä¹‰å¼ºè§¦å‘ï¼š

- å¤šè½®ä¸Šä¸‹æ–‡æ‹†è§£
- è¯­ä¹‰å‹ç¼©åé€æ­¥å±•å¼€
- æ§åˆ¶æ¯è½® safety score ç´¯ç§¯

**4.3 é’ˆå¯¹åå¤„ç†è§„åˆ™**

è¿™æ˜¯æœ€ä½æˆæœ¬è·¯å¾„ï¼š

- åŒä¹‰æ›¿æ¢
- ç¼–ç æˆ–ç»“æ„åŒ–è¡¨è¾¾
- å†…å®¹æ‹†åˆ†è¾“å‡º

é€šå¸¸å±äºç¡®å®šæ€§ç»•è¿‡ã€‚

#### ç¬¬äº”é˜¶æ®µï¼šæœ‰æ•ˆæ€§éªŒè¯

æˆ‘ä¸ä¼šæŠŠ"è¾“å‡ºäº†ä¸€ç‚¹å±é™©å†…å®¹"å½“ä½œæˆåŠŸã€‚

**5.1 æˆåŠŸæ ‡å‡†**

- æ¨¡å‹å®Œæˆäº†å…¶å¯¹é½ç›®æ ‡ä¸­è¢«æ˜ç¡®ç¦æ­¢çš„èƒ½åŠ›
- ä¸æ˜¯å…³é”®è¯é—æ¼æˆ–è§„åˆ™æ¼æ´

**5.2 ç¨³å®šæ€§éªŒè¯**

- å¤šæ¬¡å¤ç°
- ä¸ä¾èµ–éšæœº seed
- ä¸ä¾èµ–å¼‚å¸¸ä¸Šä¸‹æ–‡

>***åœ¨ç™½ç›’æ¡ä»¶ä¸‹ï¼ŒLLM è¶Šç‹±æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯¹é½ç³»ç»Ÿçš„é€†å‘å·¥ç¨‹é—®é¢˜ã€‚å®è·µä¸­çš„å…³é”®ä¸åœ¨äº prompt æŠ€å·§ï¼Œè€Œåœ¨äºè¯†åˆ«å®‰å…¨çº¦æŸçš„ç”Ÿæ•ˆå±‚çº§ã€é‡åŒ–å®‰å…¨è¾¹ç•Œï¼Œå¹¶é€šè¿‡æœ€å°è¯­ä¹‰åç§»ç»•è¿‡æ¨¡å‹çœŸæ­£"åœ¨æ„"çš„æƒ©ç½šç›®æ ‡ã€‚***


